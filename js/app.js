/* Zepto v1.0rc1 - polyfill zepto event detect fx ajax form touch - zeptojs.com/license */

(function(root){var amdExports;define("zepto",[],function(){return function(){(function(undefined){String.prototype.trim===undefined&&(String.prototype.trim=function(){return this.replace(/^\s+/,"").replace(/\s+$/,"")}),Array.prototype.reduce===undefined&&(Array.prototype.reduce=function(fun){if(this===void 0||this===null)throw new TypeError;var t=Object(this),len=t.length>>>0,k=0,accumulator;if(typeof fun!="function")throw new TypeError;if(len==0&&arguments.length==1)throw new TypeError;if(arguments.length>=2)accumulator=arguments[1];else do{if(k in t){accumulator=t[k++];break}if(++k>=len)throw new TypeError}while(!0);while(k<len)k in t&&(accumulator=fun.call(undefined,accumulator,t[k],k,t)),k++;return accumulator})})();var Zepto=function(){function isFunction(value){return toString.call(value)=="[object Function]"}function isObject(value){return value instanceof Object}function isPlainObject(value){var key,ctor;if(toString.call(value)!=="[object Object]")return!1;ctor=isFunction(value.constructor)&&value.constructor.prototype;if(!ctor||!hasOwnProperty.call(ctor,"isPrototypeOf"))return!1;for(key in value);return key===undefined||hasOwnProperty.call(value,key)}function isArray(value){return value instanceof Array}function likeArray(obj){return typeof obj.length=="number"}function compact(array){return array.filter(function(item){return item!==undefined&&item!==null})}function flatten(array){return array.length>0?[].concat.apply([],array):array}function dasherize(str){return str.replace(/::/g,"/").replace(/([A-Z]+)([A-Z][a-z])/g,"$1_$2").replace(/([a-z\d])([A-Z])/g,"$1_$2").replace(/_/g,"-").toLowerCase()}function classRE(name){return name in classCache?classCache[name]:classCache[name]=new RegExp("(^|\\s)"+name+"(\\s|$)")}function maybeAddPx(name,value){return typeof value=="number"&&!cssNumber[dasherize(name)]?value+"px":value}function defaultDisplay(nodeName){var element,display;return elementDisplay[nodeName]||(element=document.createElement(nodeName),document.body.appendChild(element),display=getComputedStyle(element,"").getPropertyValue("display"),element.parentNode.removeChild(element),display=="none"&&(display="block"),elementDisplay[nodeName]=display),elementDisplay[nodeName]}function filtered(nodes,selector){return selector===undefined?$(nodes):$(nodes).filter(selector)}function funcArg(context,arg,idx,payload){return isFunction(arg)?arg.call(context,idx,payload):arg}function insert(operator,target,node){var parent=operator%2?target:target.parentNode;parent?parent.insertBefore(node,operator?operator==1?parent.firstChild:operator==2?target:null:target.nextSibling):$(node).remove()}function traverseNode(node,fun){fun(node);for(var key in node.childNodes)traverseNode(node.childNodes[key],fun)}var undefined,key,$,classList,emptyArray=[],slice=emptyArray.slice,document=window.document,elementDisplay={},classCache={},getComputedStyle=document.defaultView.getComputedStyle,cssNumber={"column-count":1,columns:1,"font-weight":1,"line-height":1,opacity:1,"z-index":1,zoom:1},fragmentRE=/^\s*<(\w+|!)[^>]*>/,elementTypes=[1,3,8,9,11],adjacencyOperators=["after","prepend","before","append"],table=document.createElement("table"),tableRow=document.createElement("tr"),containers={tr:document.createElement("tbody"),tbody:table,thead:table,tfoot:table,td:tableRow,th:tableRow,"*":document.createElement("div")},readyRE=/complete|loaded|interactive/,classSelectorRE=/^\.([\w-]+)$/,idSelectorRE=/^#([\w-]+)$/,tagSelectorRE=/^[\w-]+$/,toString={}.toString,zepto={},camelize,uniq,tempParent=document.createElement("div");return zepto.matches=function(element,selector){if(!element||element.nodeType!==1)return!1;var matchesSelector=element.webkitMatchesSelector||element.mozMatchesSelector||element.oMatchesSelector||element.matchesSelector;if(matchesSelector)return matchesSelector.call(element,selector);var match,parent=element.parentNode,temp=!parent;return temp&&(parent=tempParent).appendChild(element),match=~zepto.qsa(parent,selector).indexOf(element),temp&&tempParent.removeChild(element),match},camelize=function(str){return str.replace(/-+(.)?/g,function(match,chr){return chr?chr.toUpperCase():""})},uniq=function(array){return array.filter(function(item,idx){return array.indexOf(item)==idx})},zepto.fragment=function(html,name){name===undefined&&(name=fragmentRE.test(html)&&RegExp.$1),name in containers||(name="*");var container=containers[name];return container.innerHTML=""+html,$.each(slice.call(container.childNodes),function(){container.removeChild(this)})},zepto.Z=function(dom,selector){return dom=dom||[],dom.__proto__=arguments.callee.prototype,dom.selector=selector||"",dom},zepto.isZ=function(object){return object instanceof zepto.Z},zepto.init=function(selector,context){if(!selector)return zepto.Z();if(isFunction(selector))return $(document).ready(selector);if(zepto.isZ(selector))return selector;var dom;if(isArray(selector))dom=compact(selector);else if(isPlainObject(selector))dom=[$.extend({},selector)],selector=null;else if(elementTypes.indexOf(selector.nodeType)>=0||selector===window)dom=[selector],selector=null;else if(fragmentRE.test(selector))dom=zepto.fragment(selector.trim(),RegExp.$1),selector=null;else{if(context!==undefined)return $(context).find(selector);dom=zepto.qsa(document,selector)}return zepto.Z(dom,selector)},$=function(selector,context){return zepto.init(selector,context)},$.extend=function(target){return slice.call(arguments,1).forEach(function(source){for(key in source)source[key]!==undefined&&(target[key]=source[key])}),target},zepto.qsa=function(element,selector){var found;return element===document&&idSelectorRE.test(selector)?(found=element.getElementById(RegExp.$1))?[found]:emptyArray:element.nodeType!==1&&element.nodeType!==9?emptyArray:slice.call(classSelectorRE.test(selector)?element.getElementsByClassName(RegExp.$1):tagSelectorRE.test(selector)?element.getElementsByTagName(selector):element.querySelectorAll(selector))},$.isFunction=isFunction,$.isObject=isObject,$.isArray=isArray,$.isPlainObject=isPlainObject,$.inArray=function(elem,array,i){return emptyArray.indexOf.call(array,elem,i)},$.trim=function(str){return str.trim()},$.uuid=0,$.map=function(elements,callback){var value,values=[],i,key;if(likeArray(elements))for(i=0;i<elements.length;i++)value=callback(elements[i],i),value!=null&&values.push(value);else for(key in elements)value=callback(elements[key],key),value!=null&&values.push(value);return flatten(values)},$.each=function(elements,callback){var i,key;if(likeArray(elements)){for(i=0;i<elements.length;i++)if(callback.call(elements[i],i,elements[i])===!1)return elements}else for(key in elements)if(callback.call(elements[key],key,elements[key])===!1)return elements;return elements},$.fn={forEach:emptyArray.forEach,reduce:emptyArray.reduce,push:emptyArray.push,indexOf:emptyArray.indexOf,concat:emptyArray.concat,map:function(fn){return $.map(this,function(el,i){return fn.call(el,i,el)})},slice:function(){return $(slice.apply(this,arguments))},ready:function(callback){return readyRE.test(document.readyState)?callback($):document.addEventListener("DOMContentLoaded",function(){callback($)},!1),this},get:function(idx){return idx===undefined?slice.call(this):this[idx]},toArray:function(){return this.get()},size:function(){return this.length},remove:function(){return this.each(function(){this.parentNode!=null&&this.parentNode.removeChild(this)})},each:function(callback){return this.forEach(function(el,idx){callback.call(el,idx,el)}),this},filter:function(selector){return $([].filter.call(this,function(element){return zepto.matches(element,selector)}))},add:function(selector,context){return $(uniq(this.concat($(selector,context))))},is:function(selector){return this.length>0&&zepto.matches(this[0],selector)},not:function(selector){var nodes=[];if(isFunction(selector)&&selector.call!==undefined)this.each(function(idx){selector.call(this,idx)||nodes.push(this)});else{var excludes=typeof selector=="string"?this.filter(selector):likeArray(selector)&&isFunction(selector.item)?slice.call(selector):$(selector);this.forEach(function(el){excludes.indexOf(el)<0&&nodes.push(el)})}return $(nodes)},eq:function(idx){return idx===-1?this.slice(idx):this.slice(idx,+idx+1)},first:function(){var el=this[0];return el&&!isObject(el)?el:$(el)},last:function(){var el=this[this.length-1];return el&&!isObject(el)?el:$(el)},find:function(selector){var result;return this.length==1?result=zepto.qsa(this[0],selector):result=this.map(function(){return zepto.qsa(this,selector)}),$(result)},closest:function(selector,context){var node=this[0];while(node&&!zepto.matches(node,selector))node=node!==context&&node!==document&&node.parentNode;return $(node)},parents:function(selector){var ancestors=[],nodes=this;while(nodes.length>0)nodes=$.map(nodes,function(node){if((node=node.parentNode)&&node!==document&&ancestors.indexOf(node)<0)return ancestors.push(node),node});return filtered(ancestors,selector)},parent:function(selector){return filtered(uniq(this.pluck("parentNode")),selector)},children:function(selector){return filtered(this.map(function(){return slice.call(this.children)}),selector)},siblings:function(selector){return filtered(this.map(function(i,el){return slice.call(el.parentNode.children).filter(function(child){return child!==el})}),selector)},empty:function(){return this.each(function(){this.innerHTML=""})},pluck:function(property){return this.map(function(){return this[property]})},show:function(){return this.each(function(){this.style.display=="none"&&(this.style.display=null),getComputedStyle(this,"").getPropertyValue("display")=="none"&&(this.style.display=defaultDisplay(this.nodeName))})},replaceWith:function(newContent){return this.before(newContent).remove()},wrap:function(newContent){return this.each(function(){$(this).wrapAll($(newContent)[0].cloneNode(!1))})},wrapAll:function(newContent){return this[0]&&($(this[0]).before(newContent=$(newContent)),newContent.append(this)),this},unwrap:function(){return this.parent().each(function(){$(this).replaceWith($(this).children())}),this},clone:function(){return $(this.map(function(){return this.cloneNode(!0)}))},hide:function(){return this.css("display","none")},toggle:function(setting){return(setting===undefined?this.css("display")=="none":setting)?this.show():this.hide()},prev:function(){return $(this.pluck("previousElementSibling"))},next:function(){return $(this.pluck("nextElementSibling"))},html:function(html){return html===undefined?this.length>0?this[0].innerHTML:null:this.each(function(idx){var originHtml=this.innerHTML;$(this).empty().append(funcArg(this,html,idx,originHtml))})},text:function(text){return text===undefined?this.length>0?this[0].textContent:null:this.each(function(){this.textContent=text})},attr:function(name,value){var result;return typeof name=="string"&&value===undefined?this.length==0||this[0].nodeType!==1?undefined:name=="value"&&this[0].nodeName=="INPUT"?this.val():!(result=this[0].getAttribute(name))&&name in this[0]?this[0][name]:result:this.each(function(idx){if(this.nodeType!==1)return;if(isObject(name))for(key in name)this.setAttribute(key,name[key]);else this.setAttribute(name,funcArg(this,value,idx,this.getAttribute(name)))})},removeAttr:function(name){return this.each(function(){this.nodeType===1&&this.removeAttribute(name)})},prop:function(name,value){return value===undefined?this[0]?this[0][name]:undefined:this.each(function(idx){this[name]=funcArg(this,value,idx,this[name])})},data:function(name,value){var data=this.attr("data-"+dasherize(name),value);return data!==null?data:undefined},val:function(value){return value===undefined?this.length>0?this[0].value:undefined:this.each(function(idx){this.value=funcArg(this,value,idx,this.value)})},offset:function(){if(this.length==0)return null;var obj=this[0].getBoundingClientRect();return{left:obj.left+window.pageXOffset,top:obj.top+window.pageYOffset,width:obj.width,height:obj.height}},css:function(property,value){if(value===undefined&&typeof property=="string")return this.length==0?undefined:this[0].style[camelize(property)]||getComputedStyle(this[0],"").getPropertyValue(property);var css="";for(key in property)typeof property[key]=="string"&&property[key]==""?this.each(function(){this.style.removeProperty(dasherize(key))}):css+=dasherize(key)+":"+maybeAddPx(key,property[key])+";";return typeof property=="string"&&(value==""?this.each(function(){this.style.removeProperty(dasherize(property))}):css=dasherize(property)+":"+maybeAddPx(property,value)),this.each(function(){this.style.cssText+=";"+css})},index:function(element){return element?this.indexOf($(element)[0]):this.parent().children().indexOf(this[0])},hasClass:function(name){return this.length<1?!1:classRE(name).test(this[0].className)},addClass:function(name){return this.each(function(idx){classList=[];var cls=this.className,newName=funcArg(this,name,idx,cls);newName.split(/\s+/g).forEach(function(klass){$(this).hasClass(klass)||classList.push(klass)},this),classList.length&&(this.className+=(cls?" ":"")+classList.join(" "))})},removeClass:function(name){return this.each(function(idx){if(name===undefined)return this.className="";classList=this.className,funcArg(this,name,idx,classList).split(/\s+/g).forEach(function(klass){classList=classList.replace(classRE(klass)," ")}),this.className=classList.trim()})},toggleClass:function(name,when){return this.each(function(idx){var newName=funcArg(this,name,idx,this.className);(when===undefined?!$(this).hasClass(newName):when)?$(this).addClass(newName):$(this).removeClass(newName)})}},["width","height"].forEach(function(dimension){$.fn[dimension]=function(value){var offset,Dimension=dimension.replace(/./,function(m){return m[0].toUpperCase()});return value===undefined?this[0]==window?window["inner"+Dimension]:this[0]==document?document.documentElement["offset"+Dimension]:(offset=this.offset())&&offset[dimension]:this.each(function(idx){var el=$(this);el.css(dimension,funcArg(this,value,idx,el[dimension]()))})}}),adjacencyOperators.forEach(function(key,operator){$.fn[key]=function(){var nodes=$.map(arguments,function(n){return isObject(n)?n:zepto.fragment(n)});if(nodes.length<1)return this;var size=this.length,copyByClone=size>1,inReverse=operator<2;return this.each(function(index,target){for(var i=0;i<nodes.length;i++){var node=nodes[inReverse?nodes.length-i-1:i];traverseNode(node,function(node){node.nodeName!=null&&node.nodeName.toUpperCase()==="SCRIPT"&&(!node.type||node.type==="text/javascript")&&window.eval.call(window,node.innerHTML)}),copyByClone&&index<size-1&&(node=node.cloneNode(!0)),insert(operator,target,node)}})},$.fn[operator%2?key+"To":"insert"+(operator?"Before":"After")]=function(html){return $(html)[key](this),this}}),zepto.Z.prototype=$.fn,zepto.camelize=camelize,zepto.uniq=uniq,$.zepto=zepto,$}();window.Zepto=Zepto,"$"in window||(window.$=Zepto),function($){function zid(element){return element._zid||(element._zid=_zid++)}function findHandlers(element,event,fn,selector){event=parse(event);if(event.ns)var matcher=matcherFor(event.ns);return(handlers[zid(element)]||[]).filter(function(handler){return handler&&(!event.e||handler.e==event.e)&&(!event.ns||matcher.test(handler.ns))&&(!fn||zid(handler.fn)===zid(fn))&&(!selector||handler.sel==selector)})}function parse(event){var parts=(""+event).split(".");return{e:parts[0],ns:parts.slice(1).sort().join(" ")}}function matcherFor(ns){return new RegExp("(?:^| )"+ns.replace(" "," .* ?")+"(?: |$)")}function eachEvent(events,fn,iterator){$.isObject(events)?$.each(events,iterator):events.split(/\s/).forEach(function(type){iterator(type,fn)})}function add(element,events,fn,selector,getDelegate,capture){capture=!!capture;var id=zid(element),set=handlers[id]||(handlers[id]=[]);eachEvent(events,fn,function(event,fn){var delegate=getDelegate&&getDelegate(fn,event),callback=delegate||fn,proxyfn=function(event){var result=callback.apply(element,[event].concat(event.data));return result===!1&&event.preventDefault(),result},handler=$.extend(parse(event),{fn:fn,proxy:proxyfn,sel:selector,del:delegate,i:set.length});set.push(handler),element.addEventListener(handler.e,proxyfn,capture)})}function remove(element,events,fn,selector){var id=zid(element);eachEvent(events||"",fn,function(event,fn){findHandlers(element,event,fn,selector).forEach(function(handler){delete handlers[id][handler.i],element.removeEventListener(handler.e,handler.proxy,!1)})})}function createProxy(event){var proxy=$.extend({originalEvent:event},event);return $.each(eventMethods,function(name,predicate){proxy[name]=function(){return this[predicate]=returnTrue,event[name].apply(event,arguments)},proxy[predicate]=returnFalse}),proxy}function fix(event){if(!("defaultPrevented"in event)){event.defaultPrevented=!1;var prevent=event.preventDefault;event.preventDefault=function(){this.defaultPrevented=!0,prevent.call(this)}}}var $$=$.zepto.qsa,handlers={},_zid=1,specialEvents={};specialEvents.click=specialEvents.mousedown=specialEvents.mouseup=specialEvents.mousemove="MouseEvents",$.event={add:add,remove:remove},$.proxy=function(fn,context){if($.isFunction(fn)){var proxyFn=function(){return fn.apply(context,arguments)};return proxyFn._zid=zid(fn),proxyFn}if(typeof context=="string")return $.proxy(fn[context],fn);throw new TypeError("expected function")},$.fn.bind=function(event,callback){return this.each(function(){add(this,event,callback)})},$.fn.unbind=function(event,callback){return this.each(function(){remove(this,event,callback)})},$.fn.one=function(event,callback){return this.each(function(i,element){add(this,event,callback,null,function(fn,type){return function(){var result=fn.apply(element,arguments);return remove(element,type,fn),result}})})};var returnTrue=function(){return!0},returnFalse=function(){return!1},eventMethods={preventDefault:"isDefaultPrevented",stopImmediatePropagation:"isImmediatePropagationStopped",stopPropagation:"isPropagationStopped"};$.fn.delegate=function(selector,event,callback){var capture=!1;if(event=="blur"||event=="focus")$.iswebkit?event=event=="blur"?"focusout":event=="focus"?"focusin":event:capture=!0;return this.each(function(i,element){add(element,event,callback,selector,function(fn){return function(e){var evt,match=$(e.target).closest(selector,element).get(0);if(match)return evt=$.extend(createProxy(e),{currentTarget:match,liveFired:element}),fn.apply(match,[evt].concat([].slice.call(arguments,1)))}},capture)})},$.fn.undelegate=function(selector,event,callback){return this.each(function(){remove(this,event,callback,selector)})},$.fn.live=function(event,callback){return $(document.body).delegate(this.selector,event,callback),this},$.fn.die=function(event,callback){return $(document.body).undelegate(this.selector,event,callback),this},$.fn.on=function(event,selector,callback){return selector==undefined||$.isFunction(selector)?this.bind(event,selector):this.delegate(selector,event,callback)},$.fn.off=function(event,selector,callback){return selector==undefined||$.isFunction(selector)?this.unbind(event,selector):this.undelegate(selector,event,callback)},$.fn.trigger=function(event,data){return typeof event=="string"&&(event=$.Event(event)),fix(event),event.data=data,this.each(function(){"dispatchEvent"in this&&this.dispatchEvent(event)})},$.fn.triggerHandler=function(event,data){var e,result;return this.each(function(i,element){e=createProxy(typeof event=="string"?$.Event(event):event),e.data=data,e.target=element,$.each(findHandlers(element,event.type||event),function(i,handler){result=handler.proxy(e);if(e.isImmediatePropagationStopped())return!1})}),result},"focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout change select keydown keypress keyup error".split(" ").forEach(function(event){$.fn[event]=function(callback){return this.bind(event,callback)}}),["focus","blur"].forEach(function(name){$.fn[name]=function(callback){if(callback)this.bind(name,callback);else if(this.length)try{this.get(0)[name]()}catch(e){}return this}}),$.Event=function(type,props){var event=document.createEvent(specialEvents[type]||"Events"),bubbles=!0;if(props)for(var name in props)name=="bubbles"?bubbles=!!props[name]:event[name]=props[name];return event.initEvent(type,bubbles,!0,null,null,null,null,null,null,null,null,null,null,null,null),event}}(Zepto),function($){function detect(ua){var os=this.os={},browser=this.browser={},webkit=ua.match(/WebKit\/([\d.]+)/),android=ua.match(/(Android)\s+([\d.]+)/),ipad=ua.match(/(iPad).*OS\s([\d_]+)/),iphone=!ipad&&ua.match(/(iPhone\sOS)\s([\d_]+)/),webos=ua.match(/(webOS|hpwOS)[\s\/]([\d.]+)/),touchpad=webos&&ua.match(/TouchPad/),kindle=ua.match(/Kindle\/([\d.]+)/),silk=ua.match(/Silk\/([\d._]+)/),blackberry=ua.match(/(BlackBerry).*Version\/([\d.]+)/);if(browser.webkit=!!webkit)browser.version=webkit[1];android&&(os.android=!0,os.version=android[2]),iphone&&(os.ios=os.iphone=!0,os.version=iphone[2].replace(/_/g,".")),ipad&&(os.ios=os.ipad=!0,os.version=ipad[2].replace(/_/g,".")),webos&&(os.webos=!0,os.version=webos[2]),touchpad&&(os.touchpad=!0),blackberry&&(os.blackberry=!0,os.version=blackberry[2]),kindle&&(os.kindle=!0,os.version=kindle[1]),silk&&(browser.silk=!0,browser.version=silk[1]),!silk&&os.android&&ua.match(/Kindle Fire/)&&(browser.silk=!0)}detect.call($,navigator.userAgent),$.__detect=detect}(Zepto),function($,undefined){function downcase(str){return str.toLowerCase()}function normalizeEvent(name){return eventPrefix?eventPrefix+name:downcase(name)}var prefix="",eventPrefix,endEventName,endAnimationName,vendors={Webkit:"webkit",Moz:"",O:"o",ms:"MS"},document=window.document,testEl=document.createElement("div"),supportedTransforms=/^((translate|rotate|scale)(X|Y|Z|3d)?|matrix(3d)?|perspective|skew(X|Y)?)$/i,clearProperties={};$.each(vendors,function(vendor,event){if(testEl.style[vendor+"TransitionProperty"]!==undefined)return prefix="-"+downcase(vendor)+"-",eventPrefix=event,!1}),clearProperties[prefix+"transition-property"]=clearProperties[prefix+"transition-duration"]=clearProperties[prefix+"transition-timing-function"]=clearProperties[prefix+"animation-name"]=clearProperties[prefix+"animation-duration"]="",$.fx={off:eventPrefix===undefined&&testEl.style.transitionProperty===undefined,cssPrefix:prefix,transitionEnd:normalizeEvent("TransitionEnd"),animationEnd:normalizeEvent("AnimationEnd")},$.fn.animate=function(properties,duration,ease,callback){return $.isObject(duration)&&(ease=duration.easing,callback=duration.complete,duration=duration.duration),duration&&(duration/=1e3),this.anim(properties,duration,ease,callback)},$.fn.anim=function(properties,duration,ease,callback){var transforms,cssProperties={},key,that=this,wrappedCallback,endEvent=$.fx.transitionEnd;duration===undefined&&(duration=.4),$.fx.off&&(duration=0);if(typeof properties=="string")cssProperties[prefix+"animation-name"]=properties,cssProperties[prefix+"animation-duration"]=duration+"s",endEvent=$.fx.animationEnd;else{for(key in properties)supportedTransforms.test(key)?(transforms||(transforms=[]),transforms.push(key+"("+properties[key]+")")):cssProperties[key]=properties[key];transforms&&(cssProperties[prefix+"transform"]=transforms.join(" ")),!$.fx.off&&typeof properties=="object"&&(cssProperties[prefix+"transition-property"]=Object.keys(properties).join(", "),cssProperties[prefix+"transition-duration"]=duration+"s",cssProperties[prefix+"transition-timing-function"]=ease||"linear")}return wrappedCallback=function(event){if(typeof event!="undefined"){if(event.target!==event.currentTarget)return;$(event.target).unbind(endEvent,arguments.callee)}$(this).css(clearProperties),callback&&callback.call(this)},duration>0&&this.bind(endEvent,wrappedCallback),setTimeout(function(){that.css(cssProperties),duration<=0&&setTimeout(function(){that.each(function(){wrappedCallback.call(this)})},0)},0),this},testEl=null}(Zepto),function($){function triggerAndReturn(context,eventName,data){var event=$.Event(eventName);return $(context).trigger(event,data),!event.defaultPrevented}function triggerGlobal(settings,context,eventName,data){if(settings.global)return triggerAndReturn(context||document,eventName,data)}function ajaxStart(settings){settings.global&&$.active++===0&&triggerGlobal(settings,null,"ajaxStart")}function ajaxStop(settings){settings.global&&!--$.active&&triggerGlobal(settings,null,"ajaxStop")}function ajaxBeforeSend(xhr,settings){var context=settings.context;if(settings.beforeSend.call(context,xhr,settings)===!1||triggerGlobal(settings,context,"ajaxBeforeSend",[xhr,settings])===!1)return!1;triggerGlobal(settings,context,"ajaxSend",[xhr,settings])}function ajaxSuccess(data,xhr,settings){var context=settings.context,status="success";settings.success.call(context,data,status,xhr),triggerGlobal(settings,context,"ajaxSuccess",[xhr,settings,data]),ajaxComplete(status,xhr,settings)}function ajaxError(error,type,xhr,settings){var context=settings.context;settings.error.call(context,xhr,type,error),triggerGlobal(settings,context,"ajaxError",[xhr,settings,error]),ajaxComplete(type,xhr,settings)}function ajaxComplete(status,xhr,settings){var context=settings.context;settings.complete.call(context,xhr,status),triggerGlobal(settings,context,"ajaxComplete",[xhr,settings]),ajaxStop(settings)}function empty(){}function mimeToDataType(mime){return mime&&(mime==htmlType?"html":mime==jsonType?"json":scriptTypeRE.test(mime)?"script":xmlTypeRE.test(mime)&&"xml")||"text"}function appendQuery(url,query){return(url+"&"+query).replace(/[&?]{1,2}/,"?")}function serializeData(options){isObject(options.data)&&(options.data=$.param(options.data)),options.data&&(!options.type||options.type.toUpperCase()=="GET")&&(options.url=appendQuery(options.url,options.data))}function serialize(params,obj,traditional,scope){var array=$.isArray(obj);$.each(obj,function(key,value){scope&&(key=traditional?scope:scope+"["+(array?"":key)+"]"),!scope&&array?params.add(value.name,value.value):(traditional?$.isArray(value):isObject(value))?serialize(params,value,traditional,key):params.add(key,value)})}var jsonpID=0,isObject=$.isObject,document=window.document,key,name,rscript=/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,scriptTypeRE=/^(?:text|application)\/javascript/i,xmlTypeRE=/^(?:text|application)\/xml/i,jsonType="application/json",htmlType="text/html",blankRE=/^\s*$/;$.active=0,$.ajaxJSONP=function(options){var callbackName="jsonp"+ ++jsonpID,script=document.createElement("script"),abort=function(){$(script).remove(),callbackName in window&&(window[callbackName]=empty),ajaxComplete("abort",xhr,options)},xhr={abort:abort},abortTimeout;return options.error&&(script.onerror=function(){xhr.abort(),options.error()}),window[callbackName]=function(data){clearTimeout(abortTimeout),$(script).remove(),delete window[callbackName],ajaxSuccess(data,xhr,options)},serializeData(options),script.src=options.url.replace(/=\?/,"="+callbackName),$("head").append(script),options.timeout>0&&(abortTimeout=setTimeout(function(){xhr.abort(),ajaxComplete("timeout",xhr,options)},options.timeout)),xhr},$.ajaxSettings={type:"GET",beforeSend:empty,success:empty,error:empty,complete:empty,context:null,global:!0,xhr:function(){return new window.XMLHttpRequest},accepts:{script:"text/javascript, application/javascript",json:jsonType,xml:"application/xml, text/xml",html:htmlType,text:"text/plain"},crossDomain:!1,timeout:0},$.ajax=function(options){var settings=$.extend({},options||{});for(key in $.ajaxSettings)settings[key]===undefined&&(settings[key]=$.ajaxSettings[key]);ajaxStart(settings),settings.crossDomain||(settings.crossDomain=/^([\w-]+:)?\/\/([^\/]+)/.test(settings.url)&&RegExp.$2!=window.location.host);var dataType=settings.dataType,hasPlaceholder=/=\?/.test(settings.url);if(dataType=="jsonp"||hasPlaceholder)return hasPlaceholder||(settings.url=appendQuery(settings.url,"callback=?")),$.ajaxJSONP(settings);settings.url||(settings.url=window.location.toString()),serializeData(settings);var mime=settings.accepts[dataType],baseHeaders={},protocol=/^([\w-]+:)\/\//.test(settings.url)?RegExp.$1:window.location.protocol,xhr=$.ajaxSettings.xhr(),abortTimeout;settings.crossDomain||(baseHeaders["X-Requested-With"]="XMLHttpRequest"),mime&&(baseHeaders.Accept=mime,mime.indexOf(",")>-1&&(mime=mime.split(",",2)[0]),xhr.overrideMimeType&&xhr.overrideMimeType(mime));if(settings.contentType||settings.data&&settings.type.toUpperCase()!="GET")baseHeaders["Content-Type"]=settings.contentType||"application/x-www-form-urlencoded";settings.headers=$.extend(baseHeaders,settings.headers||{}),xhr.onreadystatechange=function(){if(xhr.readyState==4){clearTimeout(abortTimeout);var result,error=!1;if(xhr.status>=200&&xhr.status<300||xhr.status==304||xhr.status==0&&protocol=="file:"){dataType=dataType||mimeToDataType(xhr.getResponseHeader("content-type")),result=xhr.responseText;try{dataType=="script"?(1,eval)(result):dataType=="xml"?result=xhr.responseXML:dataType=="json"&&(result=blankRE.test(result)?null:JSON.parse(result))}catch(e){error=e}error?ajaxError(error,"parsererror",xhr,settings):ajaxSuccess(result,xhr,settings)}else ajaxError(null,"error",xhr,settings)}};var async="async"in settings?settings.async:!0;xhr.open(settings.type,settings.url,async);for(name in settings.headers)xhr.setRequestHeader(name,settings.headers[name]);return ajaxBeforeSend(xhr,settings)===!1?(xhr.abort(),!1):(settings.timeout>0&&(abortTimeout=setTimeout(function(){xhr.onreadystatechange=empty,xhr.abort(),ajaxError(null,"timeout",xhr,settings)},settings.timeout)),xhr.send(settings.data?settings.data:null),xhr)},$.get=function(url,success){return $.ajax({url:url,success:success})},$.post=function(url,data,success,dataType){return $.isFunction(data)&&(dataType=dataType||success,success=data,data=null),$.ajax({type:"POST",url:url,data:data,success:success,dataType:dataType})},$.getJSON=function(url,success){return $.ajax({url:url,success:success,dataType:"json"})},$.fn.load=function(url,success){if(!this.length)return this;var self=this,parts=url.split(/\s/),selector;return parts.length>1&&(url=parts[0],selector=parts[1]),$.get(url,function(response){self.html(selector?$(document.createElement("div")).html(response.replace(rscript,"")).find(selector).html():response),success&&success.call(self)}),this};var escape=encodeURIComponent;$.param=function(obj,traditional){var params=[];return params.add=function(k,v){this.push(escape(k)+"="+escape(v))},serialize(params,obj,traditional),params.join("&").replace("%20","+")}}(Zepto),function($){$.fn.serializeArray=function(){var result=[],el;return $(Array.prototype.slice.call(this.get(0).elements)).each(function(){el=$(this);var type=el.attr("type");this.nodeName.toLowerCase()!="fieldset"&&!this.disabled&&type!="submit"&&type!="reset"&&type!="button"&&(type!="radio"&&type!="checkbox"||this.checked)&&result.push({name:el.attr("name"),value:el.val()})}),result},$.fn.serialize=function(){var result=[];return this.serializeArray().forEach(function(elm){result.push(encodeURIComponent(elm.name)+"="+encodeURIComponent(elm.value))}),result.join("&")},$.fn.submit=function(callback){if(callback)this.bind("submit",callback);else if(this.length){var event=$.Event("submit");this.eq(0).trigger(event),event.defaultPrevented||this.get(0).submit()}return this}}(Zepto),function($){function parentIfText(node){return"tagName"in node?node:node.parentNode}function swipeDirection(x1,x2,y1,y2){var xDelta=Math.abs(x1-x2),yDelta=Math.abs(y1-y2);return xDelta>=yDelta?x1-x2>0?"Left":"Right":y1-y2>0?"Up":"Down"}function longTap(){longTapTimeout=null,touch.last&&(touch.el.trigger("longTap"),touch={})}function cancelLongTap(){longTapTimeout&&clearTimeout(longTapTimeout),longTapTimeout=null}var touch={},touchTimeout,longTapDelay=750,longTapTimeout;$(document).ready(function(){var now,delta;$(document.body).bind("touchstart",function(e){now=Date.now(),delta=now-(touch.last||now),touch.el=$(parentIfText(e.touches[0].target)),touchTimeout&&clearTimeout(touchTimeout),touch.x1=e.touches[0].pageX,touch.y1=e.touches[0].pageY,delta>0&&delta<=250&&(touch.isDoubleTap=!0),touch.last=now,longTapTimeout=setTimeout(longTap,longTapDelay)}).bind("touchmove",function(e){cancelLongTap(),touch.x2=e.touches[0].pageX,touch.y2=e.touches[0].pageY}).bind("touchend",function(e){cancelLongTap(),touch.isDoubleTap?(touch.el.trigger("doubleTap"),touch={}):touch.x2&&Math.abs(touch.x1-touch.x2)>30||touch.y2&&Math.abs(touch.y1-touch.y2)>30?(touch.el.trigger("swipe")&&touch.el.trigger("swipe"+swipeDirection(touch.x1,touch.x2,touch.y1,touch.y2)),touch={}):"last"in touch&&(touch.el.trigger("tap"),touchTimeout=setTimeout(function(){touchTimeout=null,touch.el.trigger("singleTap"),touch={}},250))}).bind("touchcancel",function(){touchTimeout&&clearTimeout(touchTimeout),longTapTimeout&&clearTimeout(longTapTimeout),longTapTimeout=touchTimeout=null,touch={}})}),["swipe","swipeLeft","swipeRight","swipeUp","swipeDown","doubleTap","tap","singleTap","longTap"].forEach(function(m){$.fn[m]=function(callback){return this.bind(m,callback)}})}(Zepto),amdExports=Zepto}.call(root),amdExports})})(this),function(exports){function _extend(obj,attrs){if(attrs)for(var i in attrs)attrs.hasOwnProperty(i)&&(obj[i]=attrs[i])}function _forceForEach(obj,callback){if(obj.forEach){obj.forEach(callback);return}for(var i in obj)obj.hasOwnProperty(i)&&callback(obj[i])}function _forceIndexOf(obj,value){if(obj.indexOf)return obj.indexOf(value);for(var i in obj)if(obj[i]==value)return i;return-1}function Prompter(options){if(this===window||typeof mozmarket!="undefined"&&this==mozmarket.receipts)return new Prompter(options);options=options||{},this.overlay=null;for(var i in options)if(options.hasOwnProperty(i)&&i!="verifier"&&i!="templates"&&i!="verify"&&i!="verifierOptions"){if(this[i]===undefined)throw"Unknown option: "+i;this[i]=options[i]}if(options.templates){var old=this.templates;this.templates={};for(var i in old)this.templates[i]=old[i];for(var i in options.templates)options.templates.hasOwnProperty(i)&&(this.templates[i]=options.templates[i])}if(!this.storeURL)throw"You must provide a storeURL option";if(!this.supportHTML)throw"You must provide a supportHTML option";options.verifier&&this.respond(options.verifier);if(options.verify){var verifier=new Verifier(options.verifierOptions),self=this;verifier.verify(function(){self.respond(verifier)})}}exports.receipts||(exports.receipts={});var noNewObject=function(){return this}();typeof atob=="undefined"&&typeof Buffer!="undefined"&&(atob=function(s){return(new Buffer(s,"base64")).toString("utf8")});var Verifier=function(options){if(this===noNewObject)throw"You forgot new";options=options||{};for(var i in options)if(options.hasOwnProperty(i)&&this._validConstructorArguments.indexOf(i)==-1)throw"Illegal option to Verifier({}): "+i;this.app=undefined,this.products=[],this.receiptErrors={},this.receiptVerifications={},this._cacheStorage=options.cacheStorage||(typeof localStorage!="undefined"?localStorage:undefined),this.cacheTimeout=options.cacheTimeout||this.defaultCacheTimeout,this.state=new this.states.VerificationIncomplete(".verify() has not been called"),this.requestTimeout=options.requestTimeout||this.defaultRequestTimeout,this.refundWindow=options.refundWindow||this.defaultRefundWindow,this.installs_allowed_from=options.installs_allowed_from||undefined,this.onlog=options.onlog,options.logLevel&&(typeof options.logLevel=="string"?this.logLevel=this.levels[options.logLevel]:this.logLevel=options.logLevel)};Verifier.State=function(name,superclass){if(name===undefined)return this;var NewState=function(detail,attrs){if(this===noNewObject)throw"You forgot new";this.detail=detail,_extend(this,attrs)};return superclass===undefined&&(superclass=Verifier.State),NewState.prototype=new superclass,NewState.className=name,NewState.prototype.name=name,NewState},Verifier.State.prototype.toString=function(){var s="["+this.name;this.detail&&(s+=" "+this.detail);for(var i in this)if(this.hasOwnProperty(i)&&i!="detail"){if(typeof this[i]=="object"&&this[i]&&this[i].toSource)var repr=this[i].toSource();else var repr=JSON.stringify(this[i]);s+=" "+i+": "+repr}return s+="]",s},Verifier.states={},Verifier.states.VerificationIncomplete=Verifier.State("VerificationIncomplete"),Verifier.states.NeedsInstall=Verifier.State("NeedsInstall"),Verifier.states.MozAppsNotSupported=Verifier.State("MozAppsNotSupported"),Verifier.states.NetworkError=Verifier.State("NetworkError"),Verifier.states.NotInstalled=Verifier.State("NotInstalled",Verifier.states.NeedsInstall),Verifier.states.NoReceipts=Verifier.State("NoReceipts",Verifier.states.NeedsInstall),Verifier.states.NoValidReceipts=Verifier.State("NoValidReceipts"),Verifier.states.OK=Verifier.State("OK"),Verifier.states.OKCache=Verifier.State("OKCache",Verifier.states.OK),Verifier.states.OKStaleCache=Verifier.State("OKStaleCache",Verifier.states.OKCache),Verifier.states.InternalError=Verifier.State("InternalError"),Verifier.states.MozAppsError=Verifier.State("MozAppsError",Verifier.states.InternalError),Verifier.states.VerifierError=Verifier.State("VerifierError",Verifier.states.InternalError),Verifier.states.ServerError=Verifier.State("ServerError",Verifier.states.NetworkError),Verifier.states.toString=function(){var items=[];for(var i in this)this.hasOwnProperty(i)&&i!="toString"&&i!="detail"&&items.push(i);return items.sort(),"{"+items.join(", ")+"}"},Verifier.errors={},Verifier.errors.ReceiptFormatError=Verifier.State("ReceiptFormatError"),Verifier.errors.ReceiptParseError=Verifier.State("ReceiptParseError",Verifier.errors.ReceiptFormatError),Verifier.errors.InvalidFromStore=Verifier.State("InvalidFromStore"),Verifier.errors.Refunded=Verifier.State("Refunded"),Verifier.errors.RequestTimeout=Verifier.State("RequestTimeout",Verifier.states.ServerError),Verifier.errors.ServerStatusError=Verifier.State("ServerStatusError",Verifier.states.ServerError),Verifier.errors.InvalidServerResponse=Verifier.State("InvalidServerResponse",Verifier.states.ServerError),Verifier.errors.InvalidReceiptIssuer=Verifier.State("InvalidReceiptIssuer"),Verifier.errors.ConnectionError=Verifier.State("ConnectionError",Verifier.states.NetworkError),Verifier.errors.ReceiptExpired=Verifier.State("ReceiptExpired"),Verifier.errors.toString=Verifier.states.toString,Verifier.prototype={_validConstructorArguments:["cacheStorage","cacheTimeout","requestTimeout","refundWindow","installs_allowed_from","onlog","logLevel"],defaultCacheTimeout:864e5,defaultRequestTimeout:3e4,defaultRefundWindow:24e5,toString:function(){var self=this,s="[Verifier state: "+this.state;return this.products.length&&(s+=" products: "+this.products.map(function(i){return i.url}).join(", ")),this.iterReceiptErrors(function(receipt,error){error==self.state?s+=" Error("+receipt.substr(0,4)+"..."+receipt.substr(receipt.length-4)+"): [error is state]":s+=" Error("+receipt.substr(0,4)+"..."+receipt.substr(receipt.length-4)+"): "+error}),this.app&&(s+=" installed app: "+this.app.manifestURL),s+="]",s},iterReceiptErrors:function(callback){for(var i in this.receiptErrors)if(this.receiptErrors.hasOwnProperty(i)){var result=callback(i,this.receiptErrors[i]);if(result===!1)break}},verify:function(onVerified){var self=this;this.state=new this.states.VerificationIncomplete(".verify() has not completed");if(!navigator.mozApps){this.state=new this.states.MozAppsNotSupported("navigator.mozApps does not exist"),onVerified(self);return}var result=navigator.mozApps.getSelf();result.onsuccess=function(){try{self.app=this.result||null;if(!this.result){self.state=new self.states.NotInstalled("The app is not installed"),onVerified(self);return}self.log(self.levels.INFO,"Got application: "+this.result.manifestURL),self.verifyReceipts(this.result,onVerified)}catch(e){self.state=new self.states.VerifierError("Exception: "+e,{exception:e}),onVerified(self)}},result.onerror=function(){self.state=new self.errors.MozAppsError("Error calling mozApps.getSelf: "+(this.error&&this.error.name),{mozAppsError:this.error}),self.log(self.levels.ERROR,"Got mozApps Error: "+(this.error&&this.error.name)),onVerified(self)}},verifyReceipts:function(app,onVerified){if(!app.receipts||!app.receipts.length){app.receipts===undefined&&this.log(self.levels.ERROR,"The .receipts property of the app object is undefined (app: "+JSON.stringify(app)+")"),this.state=new this.states.NoReceipts("No receipts were found or installed");return}this.installs_allowed_from===undefined&&(this.installs_allowed_from=app.manifest.installs_allowed_from,this.log(this.levels.INFO,"Using installs_allowed_from value from manifest: "+JSON.stringify(this.installs_allowed_from)));var pending=app.receipts.length,self=this;_forceForEach(app.receipts,function(receipt){self.log(self.levels.DEBUG,"Checking receipt "+receipt.substr(0,4));var result=self._checkCache(receipt,!1);if(result){self.log(self.levels.INFO,"Got receipt ("+receipt.substr(0,4)+") status from cache: "+JSON.stringify(result)),self._addReceiptError(receipt,new self.states.OKCache),self._addReceiptVerification(receipt,result),pending--,pending||self._finishVerification(onVerified);return}try{self._verifyOneReceipt(app,receipt,function(){pending--,pending||self._finishVerification(onVerified)})}catch(e){self.log(self.levels.ERROR,"Got error in _verifyOneReceipt: "+e),self._addReceiptError(receipt,new self.states.VerifierError("Exception in _verifyOneReceipt: "+e,{exception:e})),pending--,pending||self._finishVerification(onVerified)}})},_finishVerification:function(onVerified){try{this.log(this.levels.DEBUG,"Finished all receipt verification"),this.state instanceof this.states.VerificationIncomplete&&(this.log(this.levels.DEBUG,"No serious errors during verification"),this.products.length?this.state=new this.states.OK:this.state=new this.states.NoValidReceipts("No receipts passed verification")),onVerified(this)}catch(e){this.log(this.levels.ERROR,"Fatal error in _finishVerification: "+e),this.state=new this.states.VerifierError("Exception: "+e,{exception:e}),onVerified(this)}},_verifyOneReceipt:function(app,receipt,callback){try{var parsed=this.parseReceipt(receipt)}catch(e){this._addReceiptError(receipt,new this.errors.ReceiptParseError("Error decoding JSON: "+e,{exception:e})),callback();return}var iss=parsed.iss;if(!iss){this._addReceiptError(receipt,new this.errors.ReceiptFormatError("No (or empty) iss field"),{parsed:parsed}),callback();return}if(this.installs_allowed_from&&_forceIndexOf(this.installs_allowed_from,iss)==-1&&_forceIndexOf(this.installs_allowed_from,"*")==-1){this._addReceiptError(receipt,new this.errors.InvalidReceiptIssuer("Issuer (iss) of receipt is not a valid installer: "+iss,{iss:iss,installs_allowed_from:this.installs_allowed_from})),callback();return}var verify=parsed.verify;if(!verify){this._addReceiptError(receipt,new this.errors.ReceiptFormatError("No (or empty) verify field"),{parsed:parsed}),callback();return}typeof XMLHttpRequest=="undefined"&&(XMLHttpRequest=require("xmlhttprequest").XMLHttpRequest);var req=new XMLHttpRequest,self=this,timeout=null;this.log(this.levels.INFO,"POSTing to "+verify),req.open("POST",verify),req.onreadystatechange=function(){if(req.readyState!=4)return;self.log(self.levels.INFO,"Request to "+verify+" completed with status: "+req.status),timeout&&(clearTimeout(timeout),timeout=null);if(req.status===0){self._addReceiptError(receipt,new self.errors.ConnectionError("Server could not be contacted",{request:req,url:verify})),callback();return}if(req.status==404){self._addReceiptError(receipt,new self.errors.ServerStatusError("Server responded with 404 to "+verify,{request:req,status:req.status,url:verify})),callback();return}if(req.status!=200){self._addReceiptError(receipt,new self.errors.ServerStatusError("Server responded with non-200 status: "+req.status,{request:req,status:req.status,url:verify})),callback();return}try{var result=JSON.parse(req.responseText)}catch(e){self._addReceiptError(receipt,new self.errors.InvalidServerResponse("Invalid JSON from server",{request:req,text:req.responseText})),callback();return}if(typeof result!="object"||result===null){self._addReceiptError(receipt,new self.errors.InvalidServerResponse("Server did not respond with a JSON object ("+JSON.stringify(result)+")",{request:req,text:req.responseText})),callback();return}self.log(self.levels.INFO,"Receipt ("+receipt.substr(0,4)+"...) completed with result: "+JSON.stringify(result));if(result.status=="ok"||result.status=="pending"){self._addReceiptVerification(receipt,result),result.status=="ok"&&self._saveResults(receipt,parsed,result),callback();return}if(result.status=="refunded"){self._addReceiptError(receipt,new self.errors.Refunded("Application payment was refunded",{result:result})),callback();return}if(result.status=="expired"){self._addReceiptError(receipt,new self.errors.ReceiptExpired("Receipt expired",{result:result})),self._addReceiptVerification(receipt,result),callback();return}if(result.status=="invalid"){self._addReceiptError(receipt,new self.errors.InvalidFromStore("The store reports the receipt is invalid",{result:result})),callback();return}self._addReceiptError(receipt,new self.errors.InvalidServerResponse("Store replied with unknown status: "+result.status,{result:result})),callback()},req.send(receipt),this.requestTimeout&&(timeout=setTimeout(function(){req.abort(),self.log(self.levels.ERROR,"Request to "+verify+" timed out"),self._addReceiptError(receipt,new self.errors.RequestTimeout("The request timed out after "+self.requestTimeout+" milliseconds",{request:req,url:verify})),callback()},this.requestTimeout))},_addReceiptError:function(receipt,error){this.receiptErrors[receipt]=error;if(error instanceof this.states.NetworkError){var result=this._checkCache(receipt,!0);if(result){this.log("Got stale receipt ("+receipt.substr(0,4)+") status from cache: "+JSON.stringify(result)),this._addReceiptVerification(receipt,result),this._addReceiptError(receipt,new this.states.OKStaleCache("Used a stale cache because of network error: "+error));return}}error instanceof this.states.NetworkError?this.state instanceof this.states.VerificationIncomplete&&(this.state=error):error instanceof this.states.OK&&(this.state instanceof this.states.OK||this.state instanceof this.states.VerificationIncomplete)&&(this.state=error)},_addReceiptVerification:function(receipt,result){this.receiptVerifications[receipt]=result,this.products.push(this.parseReceipt(receipt).product)},_checkCache:function(receipt,networkFailure){if(!this._cacheStorage)return null;var key=this._makeKey(receipt),value=this._cacheStorage.getItem(key);if(!value)return null;try{value=JSON.parse(value)}catch(e){return this._cacheStorage.removeItem(key),null}var result=value.result;if(!networkFailure){if(Date.now()-value.created>this.cacheTimeout)return this.log(this.levels.INFO,"Not using cache value because it is expired"),null;if(result.status=="pending")return null;var parsed=this.parseReceipt(receipt);return parsed.iat&&this.refundWindow&&value.created-parsed.iat<this.refundWindow&&Date.now()-parsed.iat>this.refundWindow?null:result}return result},_saveResults:function(receipt,parsedReceipt,result){if(!this._cacheStorage)return;var key=this._makeKey(receipt),value={created:Date.now(),result:result};this._cacheStorage.setItem(key,JSON.stringify(value))},clearCache:function(){if(!this._cacheStorage)return;var bad=[];for(var i=0;i<this._cacheStorage.length;i++){var key=this._cacheStorage.key(i);key.substr(0,16)=="receiptverifier."&&bad.push(key)}for(i=0;i<bad.length;i++)this._cacheStorage.removeItem(bad[i])},_makeKey:function(receipt){return"receiptverifier."+receipt},parseReceipt:function(receipt){if(receipt.indexOf(".")==-1)throw"Not valid JWT";var majorParts=receipt.split("~"),dataParts=majorParts[1].split("."),body=dataParts[1];return body=this.base64urldecode(body),body=JSON.parse(body),body},base64urldecode:function(s){s=s.replace(/-/g,"+"),s=s.replace(/_/g,"/");switch(s.length%4){case 0:break;case 1:s+="===";break;case 2:s+="==";break;case 3:s+="=";break;default:throw"Illegal base64url string!"}return atob(s)},base64urlencode:function(s){return s=btoa(s),s=s.replace(/\+/g,"-"),s=s.replace(/\//g,"_"),s=s.replace(/[\n=]/g,""),s},levels:{DEBUG:10,INFO:20,NOTIFY:30,WARN:40,ERROR:50},logLevel:2,log:function(level,message){if(!this.onlog||level<this.logLevel)return;this.onlog(level,message)}},Verifier.consoleLogger=function(level,message){if(!console)return;level<=this.levels.DEBUG&&console.debug?console.debug(message):level<=this.levels.INFO&&console.info?console.info(message):level<=this.levels.NOTIFY&&console.log?console.log(message):level<=this.levels.WARN&&console.warn?console.warn(message):console.error?console.error(message):console.log(message)},Verifier.prototype.levels.toString=function(){var levels=[];for(var i in this)this.hasOwnProperty(i)&&i!="toString"&&levels.push(i);var self=this;return levels.sort(function(a,b){return self[a]<self[b]?1:-1}),"{"+levels.join(", ")+"}"},Verifier.prototype.states=Verifier.states,Verifier.prototype.errors=Verifier.errors,Verifier.prototype.consoleLogger=Verifier.consoleLogger,Verifier.levels=Verifier.prototype.levels,exports.receipts.Verifier=Verifier,exports.receipts.verify=function verify(callback,options){var verifier=new Verifier(options);verifier.verify(callback)};var $=function(win,doc,undefined){function pico(sel){var ret,p,forEach=Array.prototype.forEach;return ret=sel.nodeType?[sel]:doc.querySelectorAll(sel),ret.each=function(fn){return forEach.call(ret,function(item){fn.call(item)}),ret},ret.on=function(type,handler){return ret.each(function(){on(this,type,handler)}),ret},ret.css=function(o){if(typeof o=="object"){for(p in o)ret.each(function(){this.style[p]=o[p]});return ret}return win.getComputedStyle(ret[0]).getPropertyValue(o)},ret.attr=function(o){if(typeof o=="object"){for(p in o)ret.each(function(){this.setAttribute(p,o[p])});return ret}return ret[0].getAttribute(o)},ret}var on=pico.on=function(el,type,handler){el.addEventListener(type,function(e){handler.call(e.target,e)},!1)};return pico}(typeof window!="undefined"?window:global,typeof document!="undefined"?document:undefined);Prompter.prototype={storeURL:null,allowNoInstall:!1,ignoreInternalError:!1,fatalInternalError:!1,supportHTML:null,templates:{fatalInternalError:"We have encountered a error that keeps us from continuing.  Please contact support: <%= supportHTML %>",internalError:"We have encountered an error.  You may close this dialog to continue, but please also contact support: <%= supportHTML %>",storeInstall:'Please visit the <a href="<%= quote(storeURL) %>">store page</a> to install the application.',refunded:'You purchased this app, but then got a refund.  If you still want to use the application, you must <a href="<%= quote(storeURL) %>">purchase the application again</a>.',invalidReceiptIssuer:'You purchased this application from <%= error.iss %> which is not a store we have a relationship with.  Please either <a href="<%= quote(storeURL) %>">re-purchase the application</a> or contact support: <%= supportHTML %>',invalidFromStore:'The store reports that your purchase receipt is invalid.  Please <a href="<%= quote(storeURL) %>">visit the store to reinstall the application</a>.',receiptFormatError:'Your purchase receipt is malformed.  Please <a href="<%= quote(storeURL) %>">visit the store to reinstall the application</a>.',genericError:'An error has occurred.  <a href="<%= quote(storeURL) %>">Reinstalling the application</a> may fix this problem.  If not please contact support: <%= supportHTML %>',mozAppsNotSupported:"This browser or device does not support the Marketplace Apps system."},respond:function(verifier){this.verifier=verifier;if(verifier.state instanceof verifier.states.VerificationIncomplete)throw window.console&&console.log&&(console.log("Prompter called with verifier",verifier,"before verification complete"),console.trace&&console.track()),"Prompter called before verification complete";if(verifier.state instanceof verifier.states.OK||verifier.state instanceof verifier.states.NetworkError)return;if(verifier.state instanceof verifier.states.MozAppsNotSupported){this.handleMozAppsNotSupported(verifier);return}if(verifier.state instanceof verifier.states.InternalError){if(this.ignoreInternalError)return;this.handleInternalError(verifier);return}if(verifier.state instanceof verifier.states.NeedsInstall){this.handleInstall(verifier);return}if(verifier.state instanceof verifier.states.NoValidReceipts){var bestReason=null;verifier.iterReceiptErrors(function(receipt,error){bestReason===null?bestReason=error:bestReason instanceof verifier.states.NetworkError&&(bestReason=error)}),this.handleReceiptError(verifier,bestReason);return}throw window.console&&console.log&&console.log("Unexpected state: "+verifier.state),"Unexpected state in verifier: "+verifier.state},handleMozAppsNotSupported:function(verifier){var blocking=!this.allowNoInstall;this.display(this.render(this.templates.mozAppsNotSupported),blocking)},handleInternalError:function(verifier){this.fatalInternalError?this.display(this.render(this.templates.fatalInternalError),!0):this.display(this.render(this.templates.internalError),!1)},handleInstall:function(verifier){var blocking=!this.allowNoInstall;if(this.allowNoInstall&&verifier.state instanceof verifier.states.NoReceipts)return;var template=this.templates.storeInstall,message=this.render(template);this.display(message,blocking)},handleReceiptError:function(verifier,error){this.error=error;if(error instanceof verifier.errors.Refunded)var template=this.templates.refunded;else if(error instanceof verifier.errors.InvalidReceiptIssuer)var template=this.templates.invalidReceiptIssuer;else if(error instanceof verifier.errors.InvalidFromStore)var template=this.templates.invalidFromStore;else if(error instanceof verifier.errors.ReceiptFormatError)var template=this.templates.receiptFormatError;else var template=this.templates.genericError;var message=this.render(template);this.display(message,!this.allowNoInstall)},overlayId:"moz-receiptverifier-overlay",generalStyle:"#OVERLAYID-message,#OVERLAYID-message *,#OVERLAYID-message a:hover,#OVERLAYID-message a:visited,#OVERLAYID-message a:active {\n  bottom:auto;clear:none;cursor:default;font-family:Helvetica,Arial,sans-serif;font-size:medium;font-style:normal;font-weight:normal;  height:auto;left:auto;letter-spacing:normal;line-height:1.4;max-height:none;max-width:none;min-height:0;min-width:0;overflow:visible;  right:auto;text-align:left;text-decoration:none;text-indent:0;text-transform:none;top:auto;visibility:visible;white-space:normal;  width:auto;z-index:auto;\n}\n#OVERLAYID-message a {color: #00f;}\n#OVERLAYID-message a:visited {color:#a0f;}\n#OVERLAYID-message a:hover {text-decoration:underline;}\n#OVERLAYID {\n  position:fixed;top:0;left:0;z-index:9999;background:#000;opacity:0.85;width:100%;height:100%;\n}\n#OVERLAYID-message {\n  z-index:1000;position:fixed;top:100px;left:50%;margin-left:-200px;width:400px;padding:0.75em 1em 0.75em 1em;  border:3px solid #ccc;background:#fff;opacity:1.0;color:#000;border-radius:1em;\n}\n#OVERLAYID-close {\n  display:block;position:fixed;top:91px;left:50%;margin-left:227px;z-index:1001;height:0;width:18px;padding:18px 0 0 0;  overflow:hidden;background:#000 none;border:2px solid #fff;border-radius:18px;  box-shadow:0 0 6px #000,1.6px 1.6px 1.6px rgba(0,0,0,0.3),-1.6px 1.6px 1.6px rgba(0,0,0,0.3),1.6px -1.6px 1.6px rgba(0,0,0,0.3),-1.6px -1.6px 1.6px rgba(0,0,0,0.3);  color:#fff;cursor:pointer;user-select:none;\n}\n#OVERLAYID-close-text {\n  display:block;text-align:center;width:18px;top:0px;left:0px;position:absolute;font-size:18px;line-height:18px;\n}\n",createOverlay:function(blocking){function tryCancel(){self.blocking?self.flash():self.removeOverlay()}this.removeOverlay(),this.addStyle(),this.blocking=blocking,this.overlay=$(document.createElement("div")),this.overlay.attr({id:this.overlayId}),this.message=$(document.createElement("div")),this.message.attr({id:this.overlayId+"-message"}),this.overlay[0].appendChild(this.message[0]);if(!blocking){this.close=$(document.createElement("div")),this.close.attr({id:this.overlayId+"-close"});var inner=$(document.createElement("div"));inner.attr({id:this.overlayId+"-close-text"}),inner[0].appendChild(document.createTextNode("")),this.close[0].appendChild(inner[0]),this.overlay[0].appendChild(this.close[0])}$("body").css({"z-index":"-1"})[0].appendChild(this.overlay[0]);var self=this;this.overlay.on("click",function(ev){var target=ev.target;while(target){if(self.message&&target==self.message[0])return;if(self.overlay&&target==self.overlay[0])break;target=target.parentNode}tryCancel()}),this.close&&this.close.on("click",function(){tryCancel()}),$(document).on("keypress",function(ev){ev.keyCode==27&&tryCancel()})},flash:function(){if(!this.message)return;this.message.css({border:"3px solid #f00"});var self=this;setTimeout(function(){self.message&&self.message.css({border:"3px solid #ccc"})},2e3)},removeOverlay:function(){var existing=$("#"+this.overlayId)[0];existing&&existing.parentNode.removeChild(existing),this.overlay=null,this.message=null,this.close=null},addStyle:function(){var id=this.overlayId+"-style",existing=$("#"+id);if(existing[0])return;var el=document.createElement("style");el.id=id,el.setAttribute("type","text/css");var style=this.generalStyle;style=style.replace(/OVERLAYID/g,this.overlayId),el.appendChild(document.createTextNode(style)),document.head.appendChild(el)},display:function(htmlMessage,blocking){this.message||this.createOverlay(blocking),this.message[0].innerHTML=htmlMessage},quote:function(text){return text.replace(/&/g,"&amp;").replace(/</g,"&gt;").replace(/"/g,"&quot;")},_templateCache:{},render:function(template,data){data=data||this;if(this._templateCache[template])var fn=this._templateCache[template];else{var fn=new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+template.replace(/[\r\t\n]/g," ").split("<%").join("	").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("	").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');");this._templateCache[template]=fn}return fn(data)}},exports.receipts.Prompter=Prompter}(typeof exports=="undefined"?this.mozmarket?this.mozmarket:this.mozmarket={}:exports),define("receiptverifier",function(){}),define("install",["require"],function(require){function install(){var fn=install[install.type+"Install"];fn?fn():install.trigger("error","unsupported install: "+install.type)}function triggerChange(state){install.state=state,install.trigger("change",install.state)}install.state="unknown",install.check=function(){var apps=navigator.mozApps,request;navigator.mozApps?(install.type="mozilla",request=navigator.mozApps.getSelf(),request.onsuccess=function(){this.result?triggerChange("installed"):triggerChange("uninstalled")},request.onerror=function(err){install.error=err,triggerChange("error")}):typeof chrome!="undefined"&&chrome.webstore&&chrome.app?(install.type="chromeStore",chrome.app.isInstalled?triggerChange("installed"):triggerChange("uninstalled")):typeof window.navigator.standalone!="undefined"?(install.type="ios",window.navigator.standalone?triggerChange("installed"):triggerChange("uninstalled")):(install.type="unsupported",triggerChange("unsupported"))},install.mozillaInstallUrl=location.href+"manifest.webapp",install.mozillaInstall=function(){var installRequest=navigator.mozApps.install(install.mozillaInstallUrl);installRequest.onsuccess=function(data){triggerChange("installed")},installRequest.onerror=function(err){install.error=err,triggerChange("error")}},install.chromeInstallUrl=null,install.chromeInstall=function(){chrome.webstore.install(install.chromeInstallUrl,function(){triggerChange("installed")},function(err){install.error=err,triggerChange("error")})},install.iosInstall=function(){install.trigger("showiOSInstall",navigator.platform.toLowerCase())};var events={};return install.on=function(name,func){events[name]=(events[name]||[]).concat([func])},install.off=function(name,func){if(events[name]){var res=[];for(var i=0,l=events[name].length;i<l;i++){var f=events[name][i];f!=func&&res.push()}events[name]=res}},install.trigger=function(name){var args=Array.prototype.slice.call(arguments,1);if(events[name])for(var i=0,l=events[name].length;i<l;i++)events[name][i].apply(this,args)},install.check(),install}),define("../app",["require","zepto","receiptverifier","install"],function(require){var $=require("zepto");require("receiptverifier");var install=require("install");install.on("change",function(){install.state=="uninstalled"&&install()}),install.on("error",function(e,err){alert("There was an error during installation.")}),install.state=="uninstalled"&&install()})